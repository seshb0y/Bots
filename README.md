# Discord Bot для отслеживания очков War Thunder

Бот для Discord, который отслеживает очки игроков в клане War Thunder и уведомляет о прогрессе.

## Функциональность

- Отслеживание очков игроков в клане
- Автоматические уведомления о прогрессе
- Синхронизация очков с сайтом War Thunder
- Управление списком отслеживаемых игроков
- **Автоматическое удаление отслеживаемых игроков через 21 день**
- **Автоматическая система наград за достижения**
- **Отслеживание покинувших игроков**
- **Автоматическая синхронизация клана**
- **Система уведомлений о полковых боях (ПБ)**
- **Комплексная система логирования**
- **Парсинг лидерборда War Thunder и отслеживание места полка**
- **Расширенная статистика с информацией о лидерборде**
- **Очередь на полковые бои с автоматической нумерацией**
- **Мониторинг ресурсов бота**
- **Получение личной статистики игроков из ThunderSkill**
- **Система лётной академии с автоматическими тикетами**

## Команды

- `/help` — Показать список всех команд
- `/ping` — Проверка работы бота
- `/points` — Посмотреть свои очки
- `/addtracer <nickname>` — Добавить игрока в отслеживание
- `/removetracer <nickname>` — Удалить игрока из отслеживания
- `/listtraced` — Список отслеживаемых игроков
- `/syncclan <clan>` — Синхронизировать очки участников по клану
- `/resettleavers` — Сбросить файл отслеживания покинувших игроков
- `/pbnotify` — Тестовое уведомление офицерам о ПБ
- `/stats` — Показать статистику изменений очков за сутки
- `/teststats` — Тестовая команда для проверки статистики с лидербордом
- `/resources` — Показать использование CPU и памяти ботом
- `/lichstat <nickname>` — Получить статистику игрока из ThunderSkill
- `/runtests` — Запустить тестирование бота (только для администраторов)
- `/simpletest` — Простая тестовая команда
- `/flight-academy` — Создать тикет для лётной академии War Thunder

**Примечание:** Команда `/checktracked` зарегистрирована, но не реализована в обработчике команд.

## Автоматическая система наград

Бот автоматически отслеживает игроков, достигших 1600+ ЛПР (личных полковых очков) и выдает награды в конце сезона:

### Роли наград:
- **"За безупречную службу"** (3 разновидности) — выдаются последовательно
- **"Орден Почётного Воина"** — выдается при наличии всех 3 ролей службы

### Логика работы:
1. **Отслеживание достижений** — каждый раз при сборе статистики (16:50 и 01:20) бот записывает игроков с ≥1600 ЛПР
2. **Конец сезона** — определяется автоматически когда у всех игроков очки = 0
3. **Выдача наград** — при обнаружении конца сезона:
   - Если у игрока < 3 ролей "За безупречную службу" → выдается следующая роль
   - Если у игрока все 3 роли → они снимаются и выдается "Орден Почётного Воина"

### Файлы данных:
- `data/season_achievers.json` — список игроков, достигших 1600+ ЛПР в текущем сезоне

## Отслеживание покинувших игроков

Бот автоматически отслеживает игроков, покинувших клан, и отправляет уведомления:

### Логика работы:
1. **Файл отслеживания** — `data/leavers_tracking.json` хранит последнее известное состояние клана
2. **Сравнение** — при выполнении `/syncclan` сравнивается текущее состояние с сохраненным
3. **Уведомления** — покинувшие игроки отправляются в канал (ID: `882263905009807390`)

### Формат уведомления:
```
Игрок покинул полк 30.07.2025 с 1500 лпр
```

## Автоматическая синхронизация клана

Бот автоматически выполняет синхронизацию клана **каждый день в 12:00**:

### Что происходит:
1. **Сбор данных** — получение текущего состояния клана ALLIANCE
2. **Поиск покинувших** — сравнение с предыдущим состоянием
3. **Уведомления** — отправка сообщений о покинувших игроках
4. **Обновление данных** — сохранение нового состояния и обновление статистики

## Система отслеживания игроков

Бот отслеживает новых игроков и уведомляет офицеров о их прогрессе:

### Логика работы:
- **7 дней** — если игрок не набрал 700 очков, отправляется предупреждение
- **14 дней** — повторное предупреждение офицерам
- **21 день** — автоматическое удаление из отслеживания

### Условия:
- Игроки с ≥700 очками автоматически удаляются из отслеживания
- Уведомления отправляются добавившему игрока и всем офицерам

## Система уведомлений о полковых боях (ПБ)

### Автоматические уведомления офицерам:
- **Время**: каждый день в 17:00
- **Получатели**: все участники с ролями офицеров
- **Формат**: Discord embed с кнопкой "Собираю"

### Автоматические объявления в канал:
- **Время**: каждые 20 минут с 17:00 до 22:00
- **Условие**: только если в голосовых каналах меньше 8 человек И в основном канале есть люди
- **Формат**: `@everyone +N` (где N = 8 - текущее количество людей)

### Голосовые каналы для подсчета:
- `763085196118851608` (основной канал)
- `885928590720524328` 
- `821082995188170783`

### Канал для объявлений:
- `763085196118851607`

## Система логирования

Бот ведет подробные логи всех событий:

### Файлы логов:
- **Расположение**: `logs/bot-YYYY-MM-DD.log`
- **Формат**: ежедневные файлы с датой
- **Автоочистка**: старые логи (старше 30 дней) удаляются автоматически

### Уровни логирования:
- **INFO** (зеленый) — обычные события
- **WARN** (желтый) — предупреждения  
- **ERROR** (красный) — ошибки
- **DEBUG** (голубой) — отладочная информация

### Типы событий:
- `[VOICE]` — события голосовых каналов
- `[STATS]` — сбор статистики
- `[SYNCCLAN]` — синхронизация клана
- `[PB_NOTIFY]` — уведомления о ПБ
- `[QUEUE]` — очередь на полковые бои
- `[REWARD]` — выдача наград
- `[COMMAND]` — выполнение команд
- `[INTERACTION]` — взаимодействия пользователей

### Пример лога:
```
[2024-01-15 14:30:25] [INFO] [VOICE] Канал "ПБ" обновлён: было 5, стало 6
[2024-01-15 14:30:26] [INFO] [COMMAND] Выполняется команда: points
[2024-01-15 14:30:27] [ERROR] [ERROR] Не удалось обновить канал 123456789
```

## Установка (ручная)

1. Клонируйте репозиторий:

   ```bash
   git clone <url-репозитория>
   cd DiscordBot
   ```

2. Установите зависимости:

   ```bash
   npm install
   ```

3. Создайте файл `.env` в корне проекта и добавьте:
   ```env
   DISCORD_TOKEN=ваш_токен_бота
   CLIENT_ID=id_вашего_приложения
   GUILD_ID=id_вашего_сервера
   ANNOUNCE_CHANNEL_ID=id_канала_для_уведомлений
   ```

## Альтернатива: запуск без установки Node.js

В проект входит скрипт `start-bot.bat` (Windows) и `start-bot.sh` (Linux), который:

- Сам скачает Node.js (в виде `.zip`, без установки)
- Автоматически установит зависимости
- Запустит бота
- Не требует прав администратора
- Работает двойным кликом

### 🔄 Для автозапуска с системой:

**Windows:**
1. Нажмите `Win+R` → введите `shell:startup`
2. В открывшуюся папку поместите ярлык на `start-bot.bat`
3. Готово — бот будет запускаться при входе в Windows

**Linux:**
Используйте `ecosystem.config.js` с PM2 или systemd для автозапуска.

## Запуск

1. Зарегистрируйте команды бота:

   ```bash
   npm run register
   ```

   или

   ```bash
   npx ts-node src/register-commands.ts
   ```

2. Запустите бота:
   - **Windows:** Двойной клик по `start-bot.bat`
   - **Linux:** `./start-bot.sh`
   - или вручную:
     ```bash
     npm start
     ```

## Требования

- Node.js 18+ (если не используете встроенный ZIP)
- Discord Token, Application ID, Guild ID
- Windows (для `.bat` запуска) или Linux (для `.sh` запуска)

## Структура проекта

```
DiscordBot/
├── src/
│   ├── index.ts               # Основной файл бота
│   ├── bot.ts                 # Логика бота и планировщики
│   ├── register-commands.ts   # Регистрация команд
│   ├── types.ts               # Типы данных
│   ├── constants.ts           # Константы и ID
│   ├── commands/              # Команды бота
│   │   ├── index.ts           # Обработчик команд
│   │   ├── help.ts            # Команда помощи
│   │   ├── points.ts          # Просмотр очков
│   │   ├── addtracer.ts       # Добавление в отслеживание
│   │   ├── removetracer.ts    # Удаление из отслеживания
│   │   ├── listtraced.ts      # Список отслеживаемых
│   │   ├── syncclan.ts        # Синхронизация клана
│   │   ├── resettleavers.ts   # Сброс отслеживания покинувших
│   │   ├── pbnotify.ts        # Уведомления о ПБ
│   │   ├── stats.ts           # Статистика
│   │   ├── teststats.ts       # Тестовая статистика
│   │   ├── resources.ts       # Мониторинг ресурсов
│   │   ├── lichstat.ts        # Статистика игрока
│   │   ├── runtests.ts        # Запуск тестов
│   │   └── simple-test.ts     # Простой тест
│   ├── utils/                 # Утилиты
│   │   ├── pbNotify.ts        # Система уведомлений ПБ
│   │   ├── clan.ts            # Работа с кланом
│   │   ├── leaderboard.ts     # Работа с лидербордом
│   │   ├── logger.ts          # Система логирования
│   │   ├── tracked.ts         # Отслеживание игроков
│   │   ├── normalize.ts       # Нормализация никнеймов
│   │   └── json.ts            # Работа с JSON
│   └── tests/                 # Тесты
├── data/
│   ├── users.json             # Данные пользователей
│   ├── tracked.json           # Отслеживаемые игроки
│   ├── season_achievers.json  # Достижения сезона
│   ├── leavers_tracking.json  # Отслеживание покинувших (создается автоматически)
│   ├── members_1650.json      # Состояние на 16:50 (создается автоматически)
│   ├── members_0120.json      # Состояние на 01:20 (создается автоматически)
│   ├── leaderboard_data.json  # Данные о лидерборде (создается автоматически)
│   ├── members_a.json         # Альтернативный файл состояния A (создается автоматически)
│   ├── members_b.json         # Альтернативный файл состояния B (создается автоматически)
│   ├── members_state.json     # Состояние переключения файлов (создается автоматически)
│   └── resources.log          # Лог мониторинга ресурсов
├── logs/                      # Файлы логов (создается автоматически)
├── package.json
├── package-lock.json
├── tsconfig.json
├── .env
├── .gitignore
├── ecosystem.config.js        # Конфигурация PM2
├── nodejs/                    # (если используется ZIP Node.js)
├── start-bot.bat              # Запуск бота без установки (Windows)
├── start-bot.sh               # Запуск бота без установки (Linux)
├── deploy.bat                 # Сборка для деплоя (Windows)
├── deploy.sh                  # Сборка для деплоя (Linux)
└── run-tests.ts               # Скрипт запуска тестов
```

## Примечания

- Бот использует API War Thunder для получения очков
- Данные хранятся в JSON-файлах (локально)
- Проверка очков — ежедневно в 16:50 и 01:20 (московское время)
- Синхронизация клана — ежедневно в 12:00 (московское время)
- Удаление отслеживаемых игроков — через 21 день неактивности
- **Автоматическая очистка логов** — старше 30 дней
- **Парсинг лидерборда** — с использованием Puppeteer для рендеринга JavaScript
- **Расширенная статистика** — включение информации о месте полка и изменениях в лидерборде

## Автоматическая статистика клана

- Каждый день бот автоматически собирает состояние очков всех участников клана дважды:
  - **В 16:50** — сохраняет состояние в файл `members_1650.json` и данные лидерборда
  - **В 01:20** — сохраняет состояние в файл `members_0120.json`, сравнивает с предыдущим и отправляет статистику изменений в канал Discord
- В статистику попадают только те игроки, у кого изменились очки за сутки
- Формат сообщения: информация о лидерборде, общий прирост/убыль полка и список игроков с изменениями

### Пример сообщения:

```
📊 **Статистика за сутки:**
🏆 **Место в лидерборде:** 98
📈 Поднялись на 2 места
💎 **Очки полка:** 29,900
📈 Получили 1,500 очков

Полк всего: +1234 очков

Изменения по игрокам:
• Игрок1: +100
• Игрок2: -50
...
```

### Файлы данных:

- `data/members_1650.json` — состояние участников на 16:50
- `data/members_0120.json` — состояние участников на 01:20
- `data/leaderboard_data.json` — данные о лидерборде

## Система отслеживания лидерборда War Thunder

Бот автоматически отслеживает место полка ALLIANCE в лидерборде War Thunder и включает эту информацию в статистику:

### Функциональность:
- **Парсинг лидерборда** — автоматический поиск полка ALLIANCE на страницах лидерборда (начиная с 3 страницы)
- **Сохранение данных** — ежедневное сохранение места и очков полка
- **Сравнение изменений** — отслеживание изменений места и очков
- **Расширенная статистика** — включение информации о лидерборде в ежедневную статистику

### Время сбора данных:
- **16:50** — сохранение текущего места и очков полка
- **01:20** — получение новых данных, сравнение и отправка расширенной статистики

### Технические особенности:
- **Использование Puppeteer** — для рендеринга JavaScript-контента лидерборда
- **Поиск по страницам** — автоматический поиск полка начиная с 3 страницы до 8 страницы
- **Поддержка форматов** — корректная обработка очков в форматах "29.9K", "1.2M" и т.д.
- **Обработка ошибок** — надежная работа при недоступности лидерборда

### Команды для тестирования:
- `/teststats` — тестовая команда для проверки работы с лидербордом
- `/stats` — обычная статистика (включает информацию о лидерборде)

## Очередь на полковые бои (автоматическая нумерация в голосовом канале)

- В голосовом канале "замена на полковые бои" (ID: `821082995188170783`) бот автоматически присваивает участникам номера очереди с помощью emoji-цифр (1️⃣, 2️⃣, ...).
- Порядок номеров соответствует фактическому порядку появления в канале.
- Если кто-то выходит из канала, номера у оставшихся пересчитываются подряд (без пропусков).
- При выходе из канала ник пользователя возвращается к оригинальному.
- Если канал полностью опустел, очередь сбрасывается, а последнему вышедшему возвращается оригинальный ник.
- Бот не меняет никнеймы пользователей, если не хватает прав или роль пользователя выше роли бота.
- Владелец сервера (ID: `642764542266310658`) исключен из изменения никнейма, но учитывается в очереди.

### Пример:

1️⃣ FoxHD(Сергей)
2️⃣ Спермококус(Денис)
3️⃣ Mawiile(Максим)

Если второй участник выходит, очередь становится:

1️⃣ FoxHD(Сергей)
2️⃣ Mawiile(Максим)

Новый участник получит номер 3️⃣.

## Мониторинг ресурсов

Бот включает систему мониторинга ресурсов:

### Функциональность:
- **Отслеживание производительности** — замер времени выполнения функций
- **Мониторинг CPU и памяти** — периодический сбор данных о использовании ресурсов
- **Логирование ресурсов** — сохранение данных в `data/resources.log`
- **Команда `/resources`** — просмотр текущего использования ресурсов или истории

### Отслеживаемые функции:
- `voiceStateUpdate` — обработка изменений голосовых каналов
- `updateQueueNicknames` — обновление никнеймов в очереди
- `statsScheduler` — планировщик статистики
- `syncclanScheduler` — планировщик синхронизации клана

## Статистика игроков из ThunderSkill

Команда `/lichstat` позволяет получить подробную статистику любого игрока War Thunder:

### Функциональность:
- **Получение данных** — прямой запрос к API ThunderSkill
- **Подробная статистика** — информация по всем режимам игры
- **Красивое оформление** — Discord embed с цветовым кодированием
- **Обработка ошибок** — корректная работа при недоступности данных

### Показываемые данные:
- Общая статистика (бои, победы, поражения)
- KDR (соотношение убийств к смертям)
- Винрейт (процент побед)
- Статистика по режимам (Realistic Battles, Arcade, etc.)

## Лётная академия War Thunder

Бот включает систему автоматических тикетов для лётной академии:

### Функциональность:
- **Автоматическое создание тикетов** — команда `/flight-academy` доступна только в канале лётной академии
- **Два типа обучения:**
  - **Получение лицензии** — три типа лицензий с описанием тестов
  - **Обучение навыкам** — восемь различных навыков с разными уровнями сложности
- **Интерактивные формы** — модальные окна для заполнения заявок
- **Автоматические уведомления** — отправка заявок в личные сообщения

### Типы лицензий:

#### 1. Поршневой пилот (БР 4.3-6.7)
**Тесты:**
- Дуэльный бой
- Бой против зениток в команде
- Бомбометание

#### 2. Ранние реактивы (БР 6.7-9.7)
**Тесты:**
- Дуэльный бой
- Бой против зениток в команде
- Бомбометание

#### 3. Современные реактивы (БР 9.7-14.3)
**Тесты:**
- Уход от ИК ракет
- Дуэльный бой
- Проверка умения уходить от ракет Панцирь и ИРИС-Т

### Обучение навыкам:

#### 🎯 Доступные навыки:
- **Дуэльный бой** — тактика и приёмы воздушного боя один на один
- **Работа против зениток** — эффективная борьба с наземными зенитными установками
- **Бомбометание** — точное бомбометание по наземным целям
- **Уход от ИК ракет** — приёмы уклонения от инфракрасных ракет (БР 9.7+)
- **Уход от ракет зениток** — тактика уклонения от ракет Панцирь, ИРИС-Т и других ЗРК (БР 9.7+)
- **Групповые полёты** — полёты в строю и координация действий в группе
- **Управление энергией** — эффективное управление кинетической и потенциальной энергией самолёта
- **Штурмовые действия** — эффективная атака наземных целей с использованием пушек и ракет

#### 📊 Уровни сложности:
- 🟢 **Низкая** — базовые навыки, подходит новичкам
- 🟡 **Средняя** — требует некоторого опыта
- 🔴 **Высокая** — для опытных пилотов

### Поля заявки:

#### 📜 Для получения лицензии:
- **Никнейм в War Thunder** — для идентификации игрока
- **Опыт игры** — описание опыта, часов, любимых самолётов
- **Мотивация** — цели и причины получения лицензии
- **Доступность** — удобное время для прохождения тестов

#### 🎯 Для обучения навыкам:
- **Никнейм в War Thunder** — для идентификации игрока
- **Текущий опыт** — описание опыта, уровня, любимых самолётов
- **Текущий уровень в навыке** — что уже умеете и с чем возникают трудности
- **Цели обучения** — что конкретно хотите улучшить в этом навыке
- **Доступность** — удобное время для обучения

### Автоматизация:
- **Проверка канала** — команда работает только в канале лётной академии (ID: `1411622997147521095`)
- **Отправка уведомлений** — заявки автоматически отправляются в ЛС (ID: `1011550567266533447`)
- **Логирование** — все действия записываются в лог-файлы
- **Права доступа** — команда доступна модераторам (ManageMessages)

### Использование:
1. Перейти в канал #лётная-академия
2. Выполнить команду `/flight-academy`
3. Выбрать тип лицензии
4. Заполнить форму заявки
5. Получить подтверждение отправки

## Переменные окружения (.env)

В корне проекта создайте файл `.env` со следующим содержимым:

```
DISCORD_TOKEN=ваш_токен_бота
CLIENT_ID=ID_вашего_приложения
GUILD_ID=ID_вашего_сервера
ANNOUNCE_CHANNEL_ID=ID_канала_для_уведомлений
```

**Описание переменных:**

- `DISCORD_TOKEN` — токен вашего Discord-бота (получается в Discord Developer Portal)
- `CLIENT_ID` — ID приложения Discord (бота)
- `GUILD_ID` — ID вашего Discord-сервера
- `ANNOUNCE_CHANNEL_ID` — ID текстового канала для уведомлений (например, для статистики или анонсов)

> Все ID можно получить через режим разработчика Discord (ПКМ по объекту → "Копировать ID")

**Примечание:** Роли офицеров и другие ID каналов жестко заданы в коде в файле `src/constants.ts` и `src/bot.ts`.

## Дополнительная документация

- `LOGGING.md` — подробное описание системы логирования
- `DEPLOY.md` — инструкции по развертыванию на сервере
- `LINUX_SETUP.md` — инструкции по настройке на Linux
- `TESTING.md` — документация по тестированию бота
